#!/usr/bin/env perl

use strict;
use warnings;
use FindBin;
use lib "$FindBin::RealBin/../lib";
use Sys::Hostname;
use Getopt::Long;
use CIHM::Meta::Ditto;

use Fcntl qw(:DEFAULT :flock);
my $lockfile = '/var/lock/tdr/ditto';

# Only allow one instance to run at a time..
sysopen(FH, $lockfile, O_WRONLY | O_CREAT) 
  or die "can't open lockfile=$lockfile: $!\n";
flock(FH, LOCK_EX | LOCK_NB)
  or exit 0;


my $conf = "/etc/canadiana/tdr/tdr.conf";
my $since;
#  Since can also take date format like "48hours" and "2016-01-01
my $localdocument = "ditto.".hostname;
my $all; # Flag to ignore since, and loop through all AIPs
my $ignoredate; # Flag to ignore the manifestdate

GetOptions (
    'all' => \$all,
    'ignoredate' => \$ignoredate,
    'conf:s' => \$conf,
    'since:s' => \$since,
    'localdocument:s' => \$localdocument
    );

CIHM::Meta::Ditto->new({ 
    since => $since,
    localdocument => $localdocument,
    configpath => $conf,
    all => $all,
    ignoredate => $ignoredate
                       })->run;

1;
__END__
